<html>
<head>
	<script src="http://192.168.123.103:3000/socket.io/socket.io.js"></script>   
</head>
<body>

<h1>video 1</h1>
<video id="v1"></video>

<h1>video 2</h1>
<video id="v2"></video>

<script>
var localStream;

// Peer 생성
var client = new webkitRTCPeerConnection(null,{
  optional: [{RtpDataChannels: true}]
});

// 소켓 연결
var socket = io.connect('http://localhost:3000');
socket.on('connect', function() {
	socket.emit("join");
});

// 소켓 응답
socket.on("res",function(res) {	
	var session_description = new RTCSessionDescription(res.description);

	console.log(session_description.type);

	if(session_description.type == "offer") {
		client.setRemoteDescription(session_description, function() {
			client.createAnswer(function(description) {
				client.setLocalDescription(description,function() {
					socket.emit('req', {
						description: description
					});
				});
			});
		});
	} else if(session_description.type == "answer") {
		client.setRemoteDescription(session_description);
	}
});

client.onconnection = function() {
	console.log("onconnection");
};

client.onaddstream = function (evt) {
	// console.log("onaddstream");
 //    console.log(evt.stream);
};

client.onicecandidate = function(evt) {
	// console.log("onicecandidate");
	// console.log(evt.candidate);
	if (evt.candidate) {
		// var candidate = new RTCIceCandidate({sdpMLineIndex:evt.candidate.sdpMLineIndex, candidate:evt.candidate});
		var candidate = new RTCIceCandidate(evt.candidate);
		// console.log(candidate);
		client.addIceCandidate(candidate);
	}
};

// 요청하기
function offer() {
	client.createOffer(function(description) {
		client.setLocalDescription(description,function() {
			socket.emit('req', {
				description: description
			});
		});
	});	
}

// 비디오 처리
function addStream() {
	var ret = client.addStream(localStream);
}


// 비디오
navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

var constraints = {
	video: true,
	// audio: true
};

function successCallback(localMediaStream) {
	localStream = localMediaStream;
	window.stream = localMediaStream; // stream available to console
	var video = document.querySelector("#v1");
	video.src = window.URL.createObjectURL(localMediaStream);
	video.play();
}

function errorCallback(error){
  console.log("navigator.getUserMedia error: ", error);
}

navigator.getUserMedia(constraints, successCallback, errorCallback);

function stopVideo() {
	document.querySelector("#v1").pause();
}



// other.setLocalDescription(description);


// pc1.onconnection = function() {
// 	console.log("here");
// };
// console.log(pc1);
// var pc1 = new RTCPeerConnection(cfg, con),
//     dc1 = null, tn1 = null;
// var signalingChannel = webkitCreateSignalingChannel();
// var pc;
// // var configuration = ;

// // run start(true) to initiate a call
// function start(isCaller) {
//     pc = new RTCPeerConnection(configuration);

//     // send any ice candidates to the other peer
//     pc.onicecandidate = function (evt) {
//         signalingChannel.send(JSON.stringify({ "candidate": evt.candidate }));
//     };

//     // once remote stream arrives, show it in the remote video element
//     pc.onaddstream = function (evt) {
//         remoteView.src = URL.createObjectURL(evt.stream);
//     };

//     // get the local stream, show it in the local video element and send it
//     navigator.getUserMedia({ "audio": true, "video": true }, function (stream) {
//         selfView.src = URL.createObjectURL(stream);
//         pc.addStream(stream);

//         if (isCaller)
//             pc.createOffer(gotDescription);
//         else
//             pc.createAnswer(pc.remoteDescription, gotDescription);

//         function gotDescription(desc) {
//             pc.setLocalDescription(desc);
//             signalingChannel.send(JSON.stringify({ "sdp": desc }));
//         }
//     });
// }

// signalingChannel.onmessage = function (evt) {
//     if (!pc)
//         start(false);

//     var signal = JSON.parse(evt.data);
//     if (signal.sdp)
//         pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
//     else
//         pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
// };

// start();
</script>

<button type="button" onclick="offer();">Offer</button>
<button type="button" onclick="addStream();">Add Stream</button>

</body>
</html>