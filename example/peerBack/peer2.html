<html>
<head>
	<script src="http://localhost:3000/socket.io/socket.io.js"></script>   
</head>
<body>

<h1>video 1</h1>
<video id="v1"></video>

<h1>video 2</h1>
<video id="v2"></video>

<script>
var pc1, pc2;
var localstream;
var sdpConstraints = {'mandatory': {
                        'OfferToReceiveAudio':true, 
                        'OfferToReceiveVideo':true }};

var servers = null;

function call() {
	pc1 = new RTCPeerConnection(servers);
	pc1.onicecandidate = iceCallback1; 
	pc1.addStream(localstream);
	pc1.createOffer(gotDescription1);

	pc2 = new RTCPeerConnection(servers);
	pc2.onicecandidate = iceCallback2;
	pc2.onaddstream = gotRemoteStream; 	
}

// 소켓 연결
var socket = io.connect('http://kichul.co.kr:3000');
socket.on('connect', function() {
	socket.emit("join");
});

// 소켓 응답
socket.on("res",function(res) {	
	var session_description = new RTCSessionDescription(res.description);

	console.log(session_description.type);

	if(session_description.type == "offer") {
		client.setRemoteDescription(session_description, function() {
			client.createAnswer(function(description) {
				client.setLocalDescription(description,function() {
					socket.emit('req', {
						description: description
					});
				});
			});
		});
	} else if(session_description.type == "answer") {
		client.setRemoteDescription(session_description);
	}
});

client.onconnection = function() {
	console.log("onconnection");
};

client.onaddstream = function (evt) {
	// console.log("onaddstream");
 //    console.log(evt.stream);
};

client.onicecandidate = function(evt) {
	// console.log("onicecandidate");
	// console.log(evt.candidate);
	if (evt.candidate) {
		// var candidate = new RTCIceCandidate({sdpMLineIndex:evt.candidate.sdpMLineIndex, candidate:evt.candidate});
		var candidate = new RTCIceCandidate(evt.candidate);
		// console.log(candidate);
		client.addIceCandidate(candidate);
	}
};

// 요청하기
function offer() {
	client.createOffer(function(description) {
		client.setLocalDescription(description,function() {
			socket.emit('req', {
				description: description
			});
		});
	});	
}

// 비디오 처리
function addStream() {
	var ret = client.addStream(localStream);
}


// 비디오
navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

var constraints = {
	video: true,
	// audio: true
};

function successCallback(localMediaStream) {
	localStream = localMediaStream;
	window.stream = localMediaStream; // stream available to console
	var video = document.querySelector("#v1");
	video.src = window.URL.createObjectURL(localMediaStream);
	video.play();
}

function errorCallback(error){
  console.log("navigator.getUserMedia error: ", error);
}

navigator.getUserMedia(constraints, successCallback, errorCallback);

function stopVideo() {
	document.querySelector("#v1").pause();
}
</script>

<button type="button" onclick="offer();">Offer</button>
<button type="button" onclick="addStream();">Add Stream</button>

</body>
</html>